# L3堅牢性検証 — 知見と方針の永久保存

> 管理責任: 家老(karo)
> 最終更新: 2026-02-20（cmd_187 初版作成）
> 目的: L3検証の経緯・方針転換・最終結論・次のhowを一元記録する

---

## 1. 概要 — L3検証とは何か

L3検証は、L2忍法FoF（5忍法×3モード=最大15体）の堅牢性を検証する仕組みである。

DM-signalの研究レイヤー構造:

| Layer | 名前 | 内容 |
|-------|------|------|
| L0 | 基本PF | 個別DM戦略のパラメータGS（172,818パターン） |
| L1 | 四神FoF | L0チャンピオンをGreedy Forward Selectionで組合せ（青龍/朱雀/白虎/玄武） |
| L2 | 忍法FoF | 5忍法(分身/追い風/抜き身/変わり身/加速)×3モード(激攻/鉄壁/常勝)で四神を乗り換え |
| L3 | 堅牢性検証 | L2忍法FoFが過剰最適化でないことを検証する |

L3の問いは「L2忍法の優位性は本物か、それとも多層ネストによる偶然の積み上げか」である。

---

## 2. 当初アプローチ（WF合議 — cmd_176）

### 2.1 合議の概要

cmd_176でOpus上忍4名(hayate, kagemaru, hanzo, saizo)+Codex下忍2名(sasuke, kirimaru)の6名合議を実施。テーマはL3堅牢性検証の設計。

### 2.2 Q0分析: WHY/WHAT（殿の第二指示で全面再設計）

殿の叱責「HOWに偏りすぎ。WHY/WHATが浅い」を受け、Q0を(a)-(e)の5問+相関分析Q_corrに分解して再回答。

**(a) WHY: 単層overfitとネストoverfitの質的違い**

| | 単層PF | L0→L1→L2ネスト |
|---|--------|----------------|
| overfit源泉 | 同一空間での偶然の勝者 | 偶然が層をまたいで条件付き連鎖増幅 |
| 自由度 | N(探索空間) | L0×L1構成×L2 >> 公称2.3M |
| 情報漏洩 | 単一 | L1が全期間を「見ている」→L2のOOSが汚染 |
| 教科書的検証の適用 | ほぼ適用可 | そのまま適用不可(検証も層別が必要) |

5名一致: 単層の教科書的overfit議論はこの構造に適用できない。理由は「誤差が足し算ではなく条件付きで連鎖する」。

**(b) WHAT: 「過剰最適化でない」の層別定義**

| 層 | 非overfit定義(極値ベース) |
|----|--------------------------|
| L0 | 選抜戦略が稀な上振れ1発ではなく、複数局面でNHF維持+LTJ非増加+Max Run-upが局所ノイズ非依存 |
| L1 | 12体構成がin-sample偶然相殺でなく、TCR片尾非依存+極端局面での補完関係を再現 |
| L2 | 乗り換え規則が特定順序記憶でなく、レジーム遷移局面でMRU/NHF改善再現+LTJ悪化制御 |

**(c) WHAT: 帰無仮説（層別）**

| 層 | 帰無仮説 | 棄却基準(極値ベース) |
|----|---------|---------------------|
| H0-L0 | L0チャンピオンの極値優位は同一母集団のランダム選抜で説明可能 | MRU/NHFがランダム選抜分布の上位5%に入る |
| H0-L1 | 現12体構成の尾部安定性(TCR/LTJ構造)は代替12体構成と同等 | TCR改善+LTJ非悪化が代替構成の上位5% |
| H0-L2 | 忍法乗り換えの優位は分身(均等配分)or制約付きランダム乗り換えと同等 | 極端局面でのMRU/NHF改善が再現(平均超過ではない) |

有意判定は「平均超過」ではなく「極端局面での優位が再現されるか」で棄却する（殿哲学）。

**(d) WFの限界（5名統合）**

全5名一致の盲点:
1. **L1情報漏洩**(最重大): L1が全期間GFS選出→L2のOOSにlook-ahead bias混入。WFはL2のみ検証でL1漏洩を検出不能
2. **多重検定未検証**: 2.3Mからチャンピオン1体のWFは「選択バイアス」を問わない
3. **有効独立標本不足**: 17ステップ×50%重複→有効独立OOS≈8.5回
4. **レジーム偏在**: 17窓が偶然同一レジームに集中するリスク
5. **乗り換え統計量不足**: OOS=12ヶ月で月次12回の判断点→スキルvs運の分離困難

**(e) 3本柱（最適検証方向性 — 概念レベル）**

殿の哲学から演繹した3本柱:

```
1. 層別検証 — L0/L1/L2を同時合格ではなく個別に棄却判定し原因帰属を明確化
   → 「どの層の偶然が効いているか」を識別する唯一の方法

2. 極値判定 — MRU/TCR/LTJ/NHFのみで優劣判定。平均系合否を禁止
   → 殿哲学「平均は悪/極値が全て」の直接適用
   → DSR(Sharpeベース)/WF平均維持率/ランダム平均比較 = 全て却下

3. 反証可能性 — 分身・代替構成・制約付きランダム乗り換えを対照群とし、
   「それでも極値指標で勝つか」で主張を倒せる形にする
   → 科学的手法の根本: 反証可能な仮説を立て、データで倒す
```

**Q_corr: 相関構造分析（5名一致）**

- 12体の低相関はファミリー設計の構造的帰結（資産クラス分離+リバランス非同期）。GS最適化の結果でも偶然でもない
- intra-family相関（同一四神の3モード）は高い可能性 → 実効独立素材≈4（ファミリー数）
- 危機時の相関収束(correlation breakdown)がL2忍法の最大リスク

### 2.3 Round 1設計（WF窓パラメータ — 家老統合案）

Round 1の主要共通見解（4名一致）から家老が統合した窓設計:

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| IS窓 | 60ヶ月 | ビジネスサイクル1周期(NBER平均58ヶ月)+lookback24M消費後36M有効 |
| OOS窓 | 12ヶ月 | 季節性1サイクル。月次リバランスで12回の判断点 |
| Step幅 | 6ヶ月 | 50%重複。各月2回検証 |
| 方式 | Rolling | FoFの乗り換え順序保持にはRolling必須 |
| ステップ数 | 17 | ノンパラ検定可能域 |
| 対象 | 18体 | L2チャンピオン15体+分身3体（代表のみでは選択がin-sample最適化） |

### 2.4 合格基準（Round 1案 — 後に棄却）

```
一次基準（分身ベースライン超過 — 最重要）:
  17ステップ中9ステップ以上で同モード分身に勝つこと（勝率≥53%）
  判定指標: 激攻=CAGR / 鉄壁=MaxDD / 常勝=NHR

二次基準（IS→OOS維持率）:
  維持率中央値 ≥ 50%（50%未満ステップが30%超で不合格）

壊滅ステップ排除:
  最悪OOSでNHF<20% かつ MaxDD>-70% のステップがゼロ

破局ゲート:
  LTJ(Left-tail Jumps) ≥ 3 のOOSステップが1回でもあれば不合格

最終判定: 4条件AND
```

---

## 3. 方針転換の理由

### 3.1 殿の哲学との不整合

殿の第二指示(Q0v2)により、合議の根本的問題が露呈した:

- **「平均は悪」が検証にも適用される**: WF維持率/DSR/パーミュテーション=全て平均ベースの合否判定。殿の哲学と矛盾
- **有限時間の原則**: 「正しいかどうかを問う前に、正しいかどうかを問うことが正しいかを問え」。WHY/WHATを固めないままHOW(WF窓設計)に走った
- **極値重視**: 平均的な性能維持ではなく、極端局面での振る舞いこそが本質

### 3.2 全員一致の問題（合議の失敗）

Round 2でOpus 4名全員がWF+DSR+パーミュテーションに収束。これは教科書的常識の再生産であり、合議の失敗として認定された。特にDSR(Deflated Sharpe Ratio)は殿の有限時間哲学と根本矛盾（Sharpeは平均/標準偏差の比であり、極値を直接評価しない）。

### 3.3 殿裁定: 方針転換

殿の裁定:
- Q0統合結果の3本柱(層別・極値・反証可能性)は**知見としてのみ保持**
- WF合議による検証設計は**一旦棚上げ**
- 代わりに「シンプルな独立検証を複数くぐり抜ける」アプローチへ転換
- 殿語録:「1つでは確信できなくても3-4つくぐり抜ければ信頼度は高い」

---

## 4. 最終方針 — 4シンプル独立検証

方針転換後、cmd_177〜cmd_180で4つの独立した視点からL2忍法FoFの優位性を検証した。

### 4.1 cmd_177: CAGR vs MaxDD散布図

| 項目 | 値 |
|------|-----|
| 手法 | L0/L1/L2+SPY/TQQQの散布図。北西=高CAGR+浅DD |
| 担当 | hanzo |
| PNG | outputs/charts/cmd177_cagr_vs_maxdd.png |

**所見**:
- L2は北西シフト(高CAGR+浅DD)を確認
- Kasoku-G(加速-激攻)が突出: CAGR 87.1% / MaxDD -33.8%
- 鉄壁系忍法がクラスターを形成: MaxDD -12%〜-17%
- TQQQ(37.6%/-78.9%)はL2の南東。SPY(13.6%/-23.3%)は全体の南東

**意味**: L2忍法はリターンを維持しつつリスクを低減している（FoF乗り換えの効果）。

### 4.2 cmd_178: 95%信頼区間比較

| 項目 | 値 |
|------|-----|
| 手法 | 月次リターン95%CIフォレストプロット |
| 担当 | saizo |
| PNG | outputs/charts/cmd178 |

**所見**:
- DM全層(L0/L1/L2)がSPYに**有意優位**(CI重複なし)
- TQQQとは同等(CI重複あり)
- L0→L1→L2間に月次リターン水準での有意差なし — FoF化の効果はリスク低減が本質
- L2 mean=4.01%/月 (CI: [2.76%, 5.27%])
- kawarimi 3体は月次CSV欠損で除外(12/15体で分析)

**意味**: L2忍法の月次リターン水準はDM戦略の本質的な収益力を反映しており、SPYに対する有意な超過リターンが統計的に確認された。

### 4.3 cmd_179: Calmarレシオ・ヒストグラム

| 項目 | 値 |
|------|-----|
| 手法 | Calmarレシオ(CAGR/|MaxDD|)の層別ヒストグラム+SPY/TQQQ基準線 |
| 担当 | kotaro |
| PNG | outputs/charts/cmd179_calmar_hist.png |

**所見**:
- **L0**(灰) median=0.80 < **L1**(青) 0.87 < **L2**(赤) 1.88
- L2はL0の**2.4倍**
- SPY(0.16)/TQQQ(0.53)は全L0より左（低い）
- 鉄壁系忍法が突出: Calmar 3.5〜3.9
- L1→L2の改善が劇的(+1.01)

**意味**: 各レイヤーを重ねるごとにリスク調整後リターンが改善する明確な階層構造が存在する。FoF化(L1→L2)の効果が最も大きい。

### 4.4 cmd_180: 月次リターン・ボックスプロット

| 項目 | 値 |
|------|-----|
| 手法 | L0/L1/L2+SPY/TQQQの月次リターン分布比較(boxplot) |
| 担当 | kotaro(引継ぎ。tobisaru→kotaro→kagemaru→hayate→kagemaru経由) |
| PNG | outputs/charts/cmd180_monthly_return_boxplot.png |

**所見**:
- L2 median=+3.07% > L1=+2.34% > L0=+1.98% > SPY=+1.31%
- 右テール max=+49.8%(DM全層同一) — SPY max=+15.1%(DM系の1/3)
- L0→L2でQ1上昇(-3.2%→-1.9%)しつつ右テール維持 = FoF乗り換え効果
- kawarimi 3体+kasoku 3体=6体欠落（上流CSV問題 → cmd_185で対応中）

**意味**: L2忍法は下方リスク(Q1)を改善しつつ、上方ポテンシャル(右テール)を維持している。これは「平均は悪/極値が全て」の殿哲学に合致する結果。

### 4.5 総合判定

4つの独立検証を総合すると:

| 検証 | 確認された事実 |
|------|--------------|
| 散布図 | L2は北西シフト（高CAGR+浅DD） |
| 95%CI | DM全層がSPYに有意優位。層間差なし（リスク低減が本質） |
| Calmar | L0<L1<L2の明確階層。L2はL0の2.4倍 |
| Boxplot | 下方リスク改善+右テール維持（FoF乗り換え効果） |

殿裁定: 「今の結論は極めて優秀。次はhowのターン」。15体全登録GO。

---

## 5. 次のhow — 実行計画

### 5.1 cmd_185: 上流CSV修正

| 項目 | 内容 |
|------|------|
| 問題 | kawarimi: 月次リターンCSV未生成 / kasoku: 月次CSV1行のみ(不完全実行) |
| 影響 | cmd_178/180で6体欠落(kawarimi 3体+kasoku 3体) |
| 担当 | saizo(kawarimi) + tobisaru(kasoku) → kirimaru(検証) |
| 状態 | 進行中 |

### 5.2 cmd_186: 忍法別L3判定

| 項目 | 内容 |
|------|------|
| 目的 | 4チャート(cmd_177-180)を忍法別にブレークダウンし、5忍法×3モードの個別合否判定 |
| 前提 | cmd_185完了（全15体の月次CSVが揃うこと） |
| 状態 | blocked(cmd_185待ち) |

### 5.3 cmd_175: L2忍法FoF本番登録

| 項目 | 内容 |
|------|------|
| 目的 | 15体全登録(create-ninpou-fof.md Steps 8-12) |
| 殿裁定 | 15体全登録GO。分身-激攻含む。L1単体比較による除外なし |
| 担当 | hanzo(登録) → hayate(レビュー+push) |
| 状態 | 進行中 |

### 5.4 今後のL3知見蓄積方針

4シンプル独立検証の結果は「L2忍法FoFの優位性は統計的に有意」という結論を支持している。ただし以下は未完了:

1. **全15体での再検証**: cmd_185完了後、6体欠落を解消した全15体で4チャートを再確認する（cmd_186）
2. **忍法別の粒度**: 現在の検証はL2全体としての優位性。忍法別(分身/追い風/抜き身/変わり身/加速)の個別評価はcmd_186で実施
3. **WF合議知見の保持**: cmd_176のQ0統合結果（3本柱: 層別・極値・反証可能性）は棚上げだが知見として保持。将来のL3深掘り時の出発点となる
4. **殿の4指標**: MRU(Max Run-Up) / TCR(Tail Conditional Return) / LTJ(Left-Tail Jumps) / NHF(New High Frequency)による極値ベース検定手法は未設計。教科書にない可能性もあり、独自設計が必要かもしれない
