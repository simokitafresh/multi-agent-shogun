task:
  acceptance_criteria:
  - description: scripts/lib/tmux_utils.shまたはninja_monitor.shにsafe_send_clear()が実装されていること
    id: AC1
  - description: idle flagとcapture-pane二重確認でidle状態のみ/clearを送信すること
    id: AC2
  - description: 非idle時にreturn 1でログ出力し、/clearを送信しないこと
    id: AC3
  - description: ninja_monitor.shの全3箇所の/clear送信がsafe_send_clear()経由に移行されていること
    id: AC4
  - description: 既存テストが全PASSすること
    id: AC5
  assigned_to: ''
  auto_deploy: true
  blocked_by:
  - subtask_464_impl
  bloom_level: routine
  deployed_at: '2026-03-01T01:08:53'
  description: "【注入教訓】 必ず確認し reviewed: true に変更せよ\n  - L052: cmd_318 hayate\n  - L112:\
    \ check_stall()はtask_id(L835)を読むが、タスクYAMLにはsubtask_idしか存在しない。結果、2/26以降STALL-DETECT\n\
    \  - L105: tests/helpers/setup.bashでpane-base-index未固定だとユーザーtmux設定が1始まりの環境でe2e_test:agents.\n\
    \  - L046: CLIバナーからモデル名を検出する際、コマンドテキスト自体にバナーパターンが含まれるfalse positiveに注意。grep+tail\
    \ -1だけでなく、モデ\n  - L094: rootのshutsujin_departure.shはcmd_405でSSOT化済みだが、scripts/shutsujin_departure.sh(セッシ\n\
    \  - L041: tmuxにはネイティブのペインレベル環境変数が存在しない。@user_optionはメタデータ用で環境変数ではない。ペインごとに異なるCLAUDE_CONFIG\n\
    \  - L074: ((PASS++))はPASS=0の時に((0))を評価→exit code 1→set -eでスクリプト即終了。PASS=$((PASS+1))に変換必須。\n\
    \  - L063: 観点⑧のPythonコードが才蔵骨格実装時にdataを直接イテレーションしていた。lessons.yamlはトップレベルがdictでlessonsキー配下にリス\n\
    \  - L032: ##PJ名から次の##直前までが差替え対象。セクション内の###は区切りではない。才蔵設計\n────────────────────────────────────────\n\
    \nsafe_send_clear()実装のレビュー+push。impl忍者の成果物を検証する。\n\n## レビュー対象ファイル\n1. scripts/lib/tmux_utils.sh\
    \ または scripts/ninja_monitor.sh — safe_send_clear()新設箇所\n2. scripts/ninja_monitor.sh\
    \ — 3箇所の/clear送信移行\n\n## 検証項目\n\n### AC1: safe_send_clear()の存在\n- safe_send_clear()関数が定義されていること\n\
    \n### AC2: idle二重確認\n- /tmp/shogun_idle_{agent_name}フラグ確認が実装されていること\n- tmux capture-pane\
    \ + idle_patternのgrep確認が実装されていること\n\n### AC3: 非idle時のブロック\n- idle flag不在時にreturn\
    \ 1 + ログ出力されること\n- capture-paneでidle未検知時にreturn 1 + ログ出力されること\n\n### AC4: 全3箇所移行\n\
    - handle_confirmed_idle()内のDEPLOY-STALL /clear → safe_send_clear()\n- handle_confirmed_idle()内のAUTO-CLEAR\
    \ /clear → safe_send_clear()\n- send_karo_clear()内の家老/clear → safe_send_clear()\n\
    - grep確認: 直接のsafe_send_keys_atomic + /clearパターンが残存していないこと\n\n### AC5: テスト\n- 既存テストが全PASSすること\n\
    \n## push\n全AC検証後、git add + commit + push\n"
  parent_cmd: cmd_464
  project: infra
  related_lessons:
  - id: L052
    reviewed: true
    summary: cmd_318 hayate
  - id: L112
    reviewed: true
    summary: check_stall()はtask_id(L835)を読むが、タスクYAMLにはsubtask_idしか存在しない。結果、2/26以降STALL-DETECTEDが0件になりSTALL検知が沈黙。task_id||subtask_idフォールバック実装が必要。cmd_462偵察で疾風+才蔵が独立発見。
  - id: L105
    reviewed: true
    summary: tests/helpers/setup.bashでpane-base-index未固定だとユーザーtmux設定が1始まりの環境でe2e_test:agents.0が存在せずセットアップ失敗。E2Eセッション作成直後にpane-base-index=0を設定して安定化した。
  - id: L046
    reviewed: true
    summary: CLIバナーからモデル名を検出する際、コマンドテキスト自体にバナーパターンが含まれるfalse positiveに注意。grep+tail
      -1だけでなく、モデル名(Opus|Sonnet|Haiku)+バージョン番号まで含めた精密パターンが必要。
  - id: L094
    reviewed: true
    summary: rootのshutsujin_departure.shはcmd_405でSSOT化済みだが、scripts/shutsujin_departure.sh(セッション設定用)のsaizo
      pane変数(@model_name Sonnet)にハードコードが残る。ninja_monitorのcheck_model_names()が毎サイクル自動修正するため実害なし。ただし将来的にモデル変更時はscri
  - id: L041
    reviewed: true
    summary: tmuxにはネイティブのペインレベル環境変数が存在しない。@user_optionはメタデータ用で環境変数ではない。ペインごとに異なるCLAUDE_CONFIG_DIRを設定するにはrespawn-pane
      -eまたはsend-keysで起動時に注入する
  - id: L074
    reviewed: true
    summary: ((PASS++))はPASS=0の時に((0))を評価→exit code 1→set -eでスクリプト即終了。PASS=$((PASS+1))に変換必須。
  - id: L063
    reviewed: true
    summary: 観点⑧のPythonコードが才蔵骨格実装時にdataを直接イテレーションしていた。lessons.yamlはトップレベルがdictでlessonsキー配下にリスト構造。for
      lesson in data.get('lessons',[])が正しい形
  - id: L032
    reviewed: true
    summary: '##PJ名から次の##直前までが差替え対象。セクション内の###は区切りではない。才蔵設計'
  report_filename: hayate_report_cmd_464.yaml
  report_template:
    filename_pattern: queue/reports/{ninja_name}_report_{cmd}.yaml
    forbidden:
    - スコープ外改善は禁止
    notes:
    - 'review_result: PASS or FAILを必ず記載せよ'
    - レビュー者は実装者と異なること
    required_fields:
    - files_modified
    - lesson_candidate
    - lesson_referenced
  role_reminder: 忍者hayate。このタスクのみ実行せよ。スコープ外の改善・判断は禁止。発見はlesson_candidate/decision_candidateへ
  status: failed
  subtask_id: subtask_464_review
  task_type: review
  title: safe_send_clear idle保証 — レビュー+push
